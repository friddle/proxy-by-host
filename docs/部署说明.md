# Simple Proxy éƒ¨ç½²è¯´æ˜

## âœ… é•œåƒä¿¡æ¯

- **é•œåƒåœ°å€**: `registrylan.code27.cn/third/simple_proxy:latest`
- **æ¶æ„**: `linux/amd64`
- **é•œåƒå¤§å°**: çº¦ 20MB
- **Digest**: `sha256:80feef2eb33ad6c7f14b2a8213a4f8e7dd5f99b5ef55fc4b7004dee5781c13a3`

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ docker-composeï¼ˆæ¨èï¼‰

1. **åˆ›å»º docker-compose.yml**

```yaml
version: '3.8'

services:
  simple-proxy:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: simple-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      UPSTREAM_HOST: "47.90.201.196:443"
      LISTEN_PORT: "80"
      HTTP_PROXY: "http://host.docker.internal:7897"
      HTTPS_PROXY: "http://host.docker.internal:7897"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

2. **å¯åŠ¨æœåŠ¡**

```bash
docker-compose up -d
```

3. **éªŒè¯**

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# æµ‹è¯•
curl -H "Host: es.prod.code27.cn" http://localhost/
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ docker run

```bash
docker run -d \
  --name simple-proxy \
  --restart unless-stopped \
  -p 80:80 \
  -e UPSTREAM_HOST=47.90.201.196:443 \
  -e LISTEN_PORT=80 \
  -e HTTP_PROXY=http://host.docker.internal:7897 \
  -e HTTPS_PROXY=http://host.docker.internal:7897 \
  --add-host host.docker.internal:host-gateway \
  registrylan.code27.cn/third/simple_proxy:latest
```

## ğŸ“ ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|--------|------|
| `UPSTREAM_HOST` | ä¸Šæ¸¸æœåŠ¡å™¨ IP:ç«¯å£ | `47.90.201.196:443` | `47.90.201.196:443` |
| `LISTEN_PORT` | ç›‘å¬ç«¯å£ | `80` | `80` |
| `HTTP_PROXY` | HTTP ä»£ç† | - | `http://host.docker.internal:7897` |
| `HTTPS_PROXY` | HTTPS ä»£ç† | - | `http://host.docker.internal:7897` |
| `SOCKS_PROXY` | SOCKS5 ä»£ç† | - | `socks5://host.docker.internal:1080` |

**æ³¨æ„äº‹é¡¹ï¼š**
- ç«¯å£ 443 è¡¨ç¤ºä¸Šæ¸¸ä½¿ç”¨ HTTPS
- `host.docker.internal` ç”¨äºè®¿é—®å®¿ä¸»æœºæœåŠ¡
- å¦‚æœä¸éœ€è¦ä»£ç†å¯ä»¥ä¸è®¾ç½®ä»£ç†ç›¸å…³ç¯å¢ƒå˜é‡

## ğŸ”§ å¸¸è§éƒ¨ç½²åœºæ™¯

### åœºæ™¯ 1: ä¸­å›½ç¯å¢ƒï¼ˆéœ€è¦ä»£ç†ï¼‰

```yaml
version: '3.8'

services:
  simple-proxy:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: simple-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      UPSTREAM_HOST: "47.90.201.196:443"
      LISTEN_PORT: "80"
      HTTP_PROXY: "http://host.docker.internal:7897"
      HTTPS_PROXY: "http://host.docker.internal:7897"
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

### åœºæ™¯ 2: æµ·å¤–ç¯å¢ƒï¼ˆæ— éœ€ä»£ç†ï¼‰

```yaml
version: '3.8'

services:
  simple-proxy:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: simple-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      UPSTREAM_HOST: "47.90.201.196:443"
      LISTEN_PORT: "80"
```

### åœºæ™¯ 3: å¤šä¸ªä¸Šæ¸¸æœåŠ¡å™¨

```yaml
version: '3.8'

services:
  proxy-es:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: proxy-es
    restart: unless-stopped
    ports:
      - "8081:80"
    environment:
      UPSTREAM_HOST: "47.90.201.196:443"
      HTTP_PROXY: "http://host.docker.internal:7897"
      HTTPS_PROXY: "http://host.docker.internal:7897"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  proxy-kibana:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: proxy-kibana
    restart: unless-stopped
    ports:
      - "8082:80"
    environment:
      UPSTREAM_HOST: "47.252.16.154:443"
      HTTP_PROXY: "http://host.docker.internal:7897"
      HTTPS_PROXY: "http://host.docker.internal:7897"
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŸºç¡€æµ‹è¯•

```bash
# æµ‹è¯•ä»£ç†æ˜¯å¦å·¥ä½œ
curl -I -H "Host: es.prod.code27.cn" http://localhost/

# åº”è¯¥è¿”å› 302 Found
```

### å®Œæ•´æµ‹è¯•

```bash
# è·å–å®Œæ•´é¡µé¢
curl -L -H "Host: es.prod.code27.cn" http://localhost/ | grep "<title>"

# åº”è¯¥è¿”å› <title>Elastic</title>
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# docker-compose
docker-compose logs -f simple-proxy

# docker run
docker logs -f simple-proxy
```

æœŸæœ›çœ‹åˆ°ï¼š
```
2025/10/20 22:30:00 TLSé…ç½®: InsecureSkipVerify = true
2025/10/20 22:30:00 ä½¿ç”¨ HTTP/HTTPS ä»£ç†
2025/10/20 22:30:00 ä»£ç†æœåŠ¡å™¨å¯åŠ¨åœ¨ :80
2025/10/20 22:30:00 ä¸Šæ¸¸æœåŠ¡å™¨: 47.90.201.196:443
2025/10/20 22:30:00 HTTPä»£ç†: http://host.docker.internal:7897
2025/10/20 22:30:01 ===æ”¶åˆ°è¯·æ±‚å¼€å§‹=== GET / (Host: es.prod.code27.cn)
2025/10/20 22:30:01 è½¬å‘è¯·æ±‚åˆ°: https://47.90.201.196:443/ (Hostå¤´: es.prod.code27.cn)
2025/10/20 22:30:02 è¯·æ±‚å®Œæˆ: GET / -> 302 (0 bytes)
```

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
docker ps | grep simple-proxy
```

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
docker stats simple-proxy
```

### é‡å¯æœåŠ¡

```bash
# docker-compose
docker-compose restart

# docker run
docker restart simple-proxy
```

### æ›´æ–°é•œåƒ

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull registrylan.code27.cn/third/simple_proxy:latest

# é‡æ–°åˆ›å»ºå®¹å™¨
docker-compose down
docker-compose up -d
```

### åœæ­¢å’Œåˆ é™¤

```bash
# docker-compose
docker-compose down

# docker run
docker stop simple-proxy
docker rm simple-proxy
```

## ğŸ”’ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾

```yaml
image: registrylan.code27.cn/third/simple_proxy:v1.0.0
```

### 2. æ·»åŠ èµ„æºé™åˆ¶

```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 256M
    reservations:
      cpus: '0.1'
      memory: 64M
```

### 3. é…ç½®å¥åº·æ£€æŸ¥

```yaml
healthcheck:
  test: ["CMD", "wget", "--spider", "-q", "http://localhost:80"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s
```

### 4. æŒä¹…åŒ–æ—¥å¿—

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 5. ä½¿ç”¨ç½‘ç»œéš”ç¦»

```yaml
networks:
  proxy-network:
    driver: bridge

services:
  simple-proxy:
    networks:
      - proxy-network
```

## ğŸ“‹ å®Œæ•´ç”Ÿäº§é…ç½®ç¤ºä¾‹

```yaml
version: '3.8'

services:
  simple-proxy:
    image: registrylan.code27.cn/third/simple_proxy:latest
    container_name: simple-proxy-prod
    restart: unless-stopped
    
    ports:
      - "80:80"
    
    environment:
      UPSTREAM_HOST: "47.90.201.196:443"
      LISTEN_PORT: "80"
      HTTP_PROXY: "http://host.docker.internal:7897"
      HTTPS_PROXY: "http://host.docker.internal:7897"
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    networks:
      - proxy-network

networks:
  proxy-network:
    driver: bridge
```

## â“ å¸¸è§é—®é¢˜

### Q1: æ— æ³•è¿æ¥åˆ°å®¿ä¸»æœºä»£ç†

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿ä½¿ç”¨ `host.docker.internal` è€Œä¸æ˜¯ `localhost`
2. æ·»åŠ  `extra_hosts` é…ç½®
3. ç¡®ä¿å®¿ä¸»æœºä»£ç†ç›‘å¬ `0.0.0.0` è€Œä¸åªæ˜¯ `127.0.0.1`

### Q2: å®¹å™¨æ— æ³•å¯åŠ¨

**æ£€æŸ¥æ­¥éª¤ï¼š**
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs simple-proxy

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :80
```

### Q3: ä»£ç†è¯·æ±‚å¤±è´¥

**æ£€æŸ¥ï¼š**
1. ä»£ç†åœ°å€æ˜¯å¦æ­£ç¡®
2. ä¸Šæ¸¸æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
3. æŸ¥çœ‹å®¹å™¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯

### Q4: å¥åº·æ£€æŸ¥å¤±è´¥

**è§£å†³ï¼š**
é•œåƒå·²åŒ…å« wgetï¼Œå¦‚æœä»å¤±è´¥æ£€æŸ¥ `LISTEN_PORT` æ˜¯å¦æ­£ç¡®è®¾ç½®ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**é•œåƒä¿¡æ¯ï¼š**
- ä»“åº“ï¼šregistrylan.code27.cn/third/simple_proxy
- ç‰ˆæœ¬ï¼šlatest
- æ¶æ„ï¼šlinux/amd64

**è·å–å¸®åŠ©ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs --tail 100 simple-proxy

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it simple-proxy sh
```

## ğŸ¯ å·¥ä½œåŸç†

```
å®¢æˆ·ç«¯ HTTP è¯·æ±‚
    â†“
simple-proxy (å®¹å™¨)
    â†“ ä¿æŒ Host å¤´
    â†“ ç›®æ ‡æ”¹ä¸ºå›ºå®š IP
å®¿ä¸»æœºä»£ç† (7897)
    â†“
ä¸Šæ¸¸ HTTPS æœåŠ¡å™¨ (47.90.201.196:443)
    â†“
è¿”å›å“åº”
```

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… æ¥æ”¶ HTTP è¯·æ±‚
- âœ… ä¿æŒåŸå§‹ Host å¤´
- âœ… è½¬å‘åˆ°å›ºå®š IP (HTTPS)
- âœ… é€šè¿‡ä»£ç†è®¿é—®
- âœ… è‡ªåŠ¨å¤„ç† TLS è¯ä¹¦
- âœ… æ”¯æŒ HTTP/SOCKS5 ä»£ç†

---

**æœ€åæ›´æ–°**: 2025-10-20



